---
- name: Simulate IOS Upgrade on Cisco Routers
  hosts: all
  gather_facts: no
  connection: network_cli

  tasks:

  - name: Backup Running Configuration
    ios_config:
      backup: yes
    register: backup_result

  - name: Display Backup Path
    debug:
      msg: "Backup saved at {{ backup_result.backup_path }}"

  - name: Show Flash to Check Existing Image
    ios_command:
      commands: "dir flash:"
    register: flash_output

  - name: Print Flash Contents
    debug:
      var: flash_output.stdout_lines

  - name: Copy New IOS Image via SCP
    ios_command:
      commands:
        - copy scp://192.168.206.1/c1900-universalk9-mz.SPA.155-3.M4.bin flash:
    vars:
      ansible_command_timeout: 300

  - name: Set Boot Variable
    ios_config:
      lines:
        - boot system flash:c1900-universalk9-mz.SPA.155-3.M4.bin

  - name: Save Configuration
    ios_config:
      save_when: modified

  - name: Reload the Device
    ios_command:
      commands:
        - reload
    vars:
      ansible_command_timeout: 60
    ignore_errors: yes  # Router may disconnect before responding

