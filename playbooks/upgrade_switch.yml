---
- name: Simulate IOS Upgrade on Cisco Routers
  hosts: all
  gather_facts: no
  connection: network_cli

  tasks:

  - name: ğŸ”„ Backup Running Configuration
    ios_config:
      backup: yes
    register: backup_result

  - name: âœ… Display Backup Path
    debug:
      msg: "âœ… Backup saved at {{ backup_result.backup_path }}"

  - name: ğŸ’¾ Check Flash for Existing Image
    ios_command:
      commands: "dir flash:"
    register: flash_output
    ignore_errors: yes

  - name: ğŸ§¾ Show Flash Output or Warning
    debug:
      msg: >
        {{ "âš ï¸ Flash check failed: flash directory not accessible in GNS3." 
        if flash_output.failed else flash_output.stdout[0] }}

  - name: ğŸš« Simulate Copying IOS Image via SCP
    debug:
      msg: "ğŸš« Skipping real SCP. Simulating image copy of c1900-universalk9-mz.SPA.155-3.M4.bin."

  - name: ğŸ”§ Set Boot Variable
    ios_config:
      lines:
        - boot system flash:c1900-universalk9-mz.SPA.155-3.M4.bin

  - name: ğŸ•µï¸â€â™‚ï¸ Verify Boot Variable
    ios_command:
      commands:
        - show run | include boot
    register: boot_check

  - name: âœ… Confirm Boot Variable
    debug:
      msg: "âœ… Boot variable is set correctly: {{ boot_check.stdout[0] }}"

  - name: ğŸ’¡ Show Uptime Before Reload
    ios_command:
      commands:
        - show version | include uptime
    register: uptime_output

  - name: â±ï¸ Display Uptime
    debug:
      msg: "ğŸ•’ Device uptime: {{ uptime_output.stdout[0] | default('N/A') }}"

  - name: ğŸ’¾ Save Configuration
    block:
      - ios_config:
          save_when: modified
        vars:
          ansible_command_timeout: 60
    rescue:
      - debug:
          msg: "âš ï¸ Save config failed on {{ inventory_hostname }}, continuing..."

  - name: ğŸ” Simulate Device Reload
    ios_command:
      commands:
        - reload
    vars:
      ansible_command_timeout: 60
    ignore_errors: yes

  - name: ğŸ“Ÿ Simulate Show Version After Reload
    debug:
      msg: "ğŸ“Ÿ Simulating 'show version' - Device assumed reloaded successfully."

  - name: âœ… Final Status Message
    debug:
      msg: "ğŸ‰ IOS upgrade simulation completed on {{ inventory_hostname }}!"
